/*! backbone.dropboxdatastore - v0.2.1 - 2013-10-10
* Copyright (c) 2013 Dmytro Yarmak <dmytroyarmak@gmail.com>;*/
!function(a,b){"use strict";"object"==typeof exports&&"function"==typeof require?module.exports=b(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],function(c,d){return b(c||a._,d||a.Backbone)}):b(_,Backbone)}(this,function(a,b){"use strict";return b.DropboxDatastore=function(a){this.name=a},a.extend(b.DropboxDatastore.prototype,{create:function(a,c){this.getTable(function(d){var e=d.insert(a.toJSON());c(b.DropboxDatastore.recordToJson(e))})},update:function(c,d){this.getTable(a.bind(function(a){var e=this._findRecordSync(a,c);e?e.update(c.toJSON()):e=a.insert(c.toJSON()),d(b.DropboxDatastore.recordToJson(e))},this))},find:function(c,d){this.getTable(a.bind(function(a){var e=this._findRecordSync(a,c);if(!e)throw new Error("Record not found");d(b.DropboxDatastore.recordToJson(e))},this))},findAll:function(c){this.getTable(function(d){var e=a.map(d.query(),b.DropboxDatastore.recordToJson);c(e)})},destroy:function(b,c){this.getTable(a.bind(function(a){var d=this._findRecordSync(a,b);d&&d.deleteRecord(),c({})},this))},getTable:function(c){this._table?a.defer(c,this._table):b.DropboxDatastore.getDatastore(a.bind(function(a){this._table=a.getTable(this.name),c(this._table)},this))},_findRecordSync:function(b,c){var d,e={};if(c.isNew())throw new Error("Cannot fetch data for model without id");return"id"===c.idAttribute?d=b.get(c.id):(e[c.idAttribute]=c.id,d=a.first(b.query(e))),d}}),a.extend(b.DropboxDatastore,{getDatastore:function(b){var c;this._datastore?a.defer(b,this._datastore):(c=a.bind(this._onOpenDefaultDatastore,this,b),this.getDatastoreManager().openDefaultDatastore(c))},_onOpenDefaultDatastore:function(a,b,c){if(b)throw new Error("Error on openDefaultDatastore: "+b.responseText);this._datastore=c,a(c)},getDatastoreManager:function(){return this.getDropboxClient().getDatastoreManager()},getDropboxClient:function(){var a=b.DropboxDatastore.client;if(!a)throw new Error("Client should be defined for Backbone.DropboxDatastore");if(!a.isAuthenticated())throw new Error("Client should be authenticated for Backbone.DropboxDatastore");return a},recordToJson:function(b){return a.extend(b.getFields(),{id:b.getId()})},sync:function(c,d,e){var f=d.dropboxDatastore||d.collection.dropboxDatastore,g=b.$.Deferred&&b.$.Deferred(),h=a.partial(b.DropboxDatastore._syncCallback,d,e,g);switch(c){case"read":d instanceof b.Collection?f.findAll(h):f.find(d,h);break;case"create":f.create(d,h);break;case"update":f.update(d,h);break;case"delete":f.destroy(d,h)}return g&&g.promise()},_syncCallback:function(a,c,d,e){c&&c.success&&("0.9.10"===b.VERSION?c.success(a,e,c):c.success(e)),d&&d.resolve(e)}}),b.originalSync=b.sync,b.getSyncMethod=function(a){return a.dropboxDatastore||a.collection&&a.collection.dropboxDatastore?b.DropboxDatastore.sync:b.originalSync},b.sync=function(a,c,d){return b.getSyncMethod(c).call(this,a,c,d)},b.DropboxDatastore});